<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2017 杭州端点网络科技有限公司, Code Generated by terminus code gen
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="ShopOrder">
    <sql id="queryCondition">
        <if test="buyerId != null">AND buyer_id IN
            <foreach collection="buyerId" open="(" separator="," close=")" item="st">
                #{st}
            </foreach>
        </if>
        <if test="shopId != null">AND shop_id IN
            <foreach collection="shopId" open="(" separator="," close=")" item="st">
                #{st}
            </foreach>
        </if>
        <if test="status != null">AND status IN
            <foreach collection="status" open="(" separator="," close=")" item="st">
                #{st}
            </foreach>
        </if>
        <if test="startAt != null">AND <![CDATA[created_at >= #{startAt}]]> </if>
        <if test="endAt != null">AND <![CDATA[created_at <= #{endAt}]]> </if>
    </sql>

    <sql id="queryConditionExt">
        <if test="statusNotIn != null">AND status NOT IN
            <foreach collection="statusNotIn" open="(" separator="," close=")" item="st">
                #{st}
            </foreach>
        </if>
        <if test="status != null">AND status IN
            <foreach collection="status" open="(" separator="," close=")" item="st">
                #{st}
            </foreach>
        </if>
        <if test="shopId == null">
            <if test="shopIds != null">AND shop_id IN
                <foreach collection="shopIds" open="(" separator="," close=")" item="st">
                    #{st}
                </foreach>
            </if>
        </if>
        <if test="id!=null">AND `id`=#{id}</if>
        <if test="buyerId != null">AND `buyer_id` = #{buyerId}</if>
        <if test="shopId != null">AND `shop_id` = #{shopId}</if>
        <if test="companyId != null">AND `company_id` = #{companyId}</if>
        <if test="outId != null">AND `out_id` = #{outId}</if>
        <if test="hasRefund != null">AND `has_refund` = #{hasRefund}</if>
        <if test="startAt != null">AND <![CDATA[created_at >= #{startAt}]]> </if>
        <if test="endAt != null">AND <![CDATA[created_at <= #{endAt}]]> </if>
    </sql>

    <select id="findByBuyerIds" parameterType="map" resultMap="ShopOrderMap">
        select id,
        <include refid="cols_exclude_id"/>
        from
        <include refid="tb"/>
        <where>
            <include refid="queryCondition"/>
        </where>
        order by `id` desc
    </select>

    <select id="pagingExt" parameterType="map" resultMap="ShopOrderMap">
        select id,
        <include refid="cols_exclude_id"/>
        from
        <include refid="tb"/>
        <where>
            <include refid="queryConditionExt"/>
        </where>
        order by `id` desc
        limit #{offset}, #{limit}
    </select>

    <select id="countExt" parameterType="map" resultType="long">
        select count(1) from
        <include refid="tb"/>
        <where>
            <include refid="queryConditionExt"/>
        </where>
    </select>

    <!-- 根据付款时间查询(今日付款)订单,包括线下转账订单(已付款待运营,一级或二级审核状态) -->
    <select id="pagingTodayPaymentOrder" parameterType="map" resultMap="ShopOrderMap">
        select * from (select a.*  from   parana_shop_orders a
        <where>
            a.`pay_type` = 3
            AND a.`status` IN (3,7,9)
            <if test="startAt != null">AND <![CDATA[a.updated_at >= #{startAt}]]> </if>
            <if test="endAt != null">AND <![CDATA[a.updated_at <= #{endAt}]]> </if>
        </where>
        ) t1

        UNION ALL

        select * from (select a.* from
        ( parana_shop_orders a left join parana_order_payments b on a.id = b.`order_id` ) left join parana_payments c on b.`payment_id` = c.`id`
        <where>
            c.`status` = 1
            <if test="startAt != null">AND <![CDATA[c.paid_at >= #{startAt}]]> </if>
            <if test="endAt != null">AND <![CDATA[c.paid_at <= #{endAt}]]> </if>
        </where>
        ) t2
        order by `id` DESC
        limit #{offset}, #{limit}
    </select>

    <select id="countTodayPaymentOrder" parameterType="map" resultType="long">
        select sum(count_number) from
        (
            select count(1) as count_number from (select a.*  from   parana_shop_orders a
            <where>
                a.`pay_type` = 3
                AND a.`status` IN (3,7,9)
                <if test="startAt != null">AND <![CDATA[a.updated_at >= #{startAt}]]> </if>
                <if test="endAt != null">AND <![CDATA[a.updated_at <= #{endAt}]]> </if>
            </where>
            ) t1

        UNION ALL

            select count(1) as count_number from (select a.* from
            ( parana_shop_orders a left join parana_order_payments b on a.id = b.`order_id` ) left join parana_payments c on b.`payment_id` = c.`id`
            <where>
                c.`status` = 1
                <if test="startAt != null">AND <![CDATA[c.paid_at >= #{startAt}]]> </if>
                <if test="endAt != null">AND <![CDATA[c.paid_at <= #{endAt}]]> </if>
            </where>
            ) t2
        ) t
    </select>

</mapper>